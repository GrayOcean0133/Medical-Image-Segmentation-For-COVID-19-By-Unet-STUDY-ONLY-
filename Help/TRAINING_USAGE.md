# è®­ç»ƒç³»ç»Ÿä½¿ç”¨è¯´æ˜ - å·²æ›´æ–°ä¸ºæ¯ä¸ªBatchè¾“å‡º

## âš ï¸ é‡è¦æ›´æ–°

**é»˜è®¤è¡Œä¸ºå·²ä¿®æ”¹**ï¼šç°åœ¨è®­ç»ƒæ—¶ä¼š**æ¯ä¸ªbatchéƒ½è¾“å‡º**æ—¥å¿—ä¿¡æ¯ï¼Œè®©ä½ å®æ—¶çœ‹åˆ°æ¯ä¸€æ­¥çš„losså˜åŒ–ï¼

---

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€è®­ç»ƒï¼ˆæ¯ä¸ªbatchéƒ½æ˜¾ç¤ºï¼‰

```bash
python src/train_ddp.py
```

**ä½ ä¼šçœ‹åˆ°**ï¼š
```
Epoch [1/200] - è¿›åº¦ 0.0% (0/171) - Batch Loss: 0.523415 - LR: 0.00100000
Epoch [1/200] - è¿›åº¦ 0.6% (1/171) - Batch Loss: 0.498234 - LR: 0.00100000
Epoch [1/200] - è¿›åº¦ 1.2% (2/171) - Batch Loss: 0.476123 - LR: 0.00100000
Epoch [1/200] - è¿›åº¦ 1.8% (3/171) - Batch Loss: 0.461567 - LR: 0.00100000
...ï¼ˆæ¯ä¸ªbatchéƒ½ä¼šè¾“å‡ºï¼‰
```

è¿™æ ·ä½ å¯ä»¥ï¼š
- âœ… å®æ—¶çœ‹åˆ°æ¯ä¸€æ­¥çš„losså˜åŒ–
- âœ… ç«‹å³å‘ç°è®­ç»ƒé—®é¢˜
- âœ… å­¦ä¹ lossçš„æ³¢åŠ¨è§„å¾‹
- âœ… æ›´å¥½åœ°ç†è§£è®­ç»ƒè¿‡ç¨‹

---

## è°ƒæ•´è¾“å‡ºé¢‘ç‡

### å¦‚æœè§‰å¾—è¾“å‡ºå¤ªé¢‘ç¹

```bash
# æ¯10ä¸ªbatchè¾“å‡ºä¸€æ¬¡ï¼ˆå‡å°‘è¾“å‡ºï¼‰
python src/train_ddp.py --log_interval 10

# æ¯50ä¸ªbatchè¾“å‡ºä¸€æ¬¡ï¼ˆæ›´å°‘è¾“å‡ºï¼‰
python src/train_ddp.py --log_interval 50
```

### å¦‚æœéœ€è¦è®°å½•è¯¦ç»†æ•°æ®åˆ°CSV

```bash
# é™¤äº†å±å¹•æ˜¾ç¤ºï¼Œè¿˜ä¿å­˜æ¯ä¸ªbatchçš„æ•°æ®åˆ°CSVæ–‡ä»¶
python src/train_ddp.py --log_batch_metrics
```

âš ï¸ æ³¨æ„ï¼š`--log_batch_metrics` ä¼šç”Ÿæˆçº¦34,000è¡Œçš„CSVæ–‡ä»¶ï¼ˆ200 epochs Ã— 171 batchesï¼‰

---

## å®Œæ•´å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|--------|------|------|
| `--log_interval` | **1** | å±å¹•è¾“å‡ºé—´éš”ï¼ˆæ¯Nä¸ªbatchï¼‰ | `--log_interval 10` |
| `--log_batch_metrics` | False | æ˜¯å¦ä¿å­˜batchæ•°æ®åˆ°CSV | `--log_batch_metrics` |
| `--epochs` | 200 | è®­ç»ƒè½®æ•° | `--epochs 100` |
| `--batch_size` | 4 | æ¯ä¸ªGPUçš„batchå¤§å° | `--batch_size 8` |
| `--lr` | 0.001 | å­¦ä¹ ç‡ | `--lr 0.0001` |

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå­¦ä¹ è®­ç»ƒè¿‡ç¨‹ï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
# ä½¿ç”¨é»˜è®¤è®¾ç½®ï¼Œæ¯ä¸ªbatchéƒ½çœ‹å¾—åˆ°
python src/train_ddp.py --epochs 10
```

**é€‚åˆ**ï¼š
- ç¬¬ä¸€æ¬¡è®­ç»ƒ
- å­¦ä¹ AIæ¨¡å‹
- è°ƒè¯•è®­ç»ƒé—®é¢˜
- è§‚å¯Ÿlosså˜åŒ–è§„å¾‹

### åœºæ™¯2ï¼šé•¿æ—¶é—´è®­ç»ƒï¼ˆæ¨èç»éªŒç”¨æˆ·ï¼‰

```bash
# å‡å°‘è¾“å‡ºï¼Œé¿å…æ—¥å¿—å¤ªé•¿
python src/train_ddp.py --log_interval 20 --epochs 200
```

**é€‚åˆ**ï¼š
- æ­£å¼è®­ç»ƒ
- é•¿æ—¶é—´è¿è¡Œ
- å·²ç»ç†Ÿæ‚‰è®­ç»ƒè¿‡ç¨‹

### åœºæ™¯3ï¼šæ·±åº¦åˆ†æï¼ˆæ¨èç ”ç©¶ï¼‰

```bash
# è®°å½•æ‰€æœ‰batchæ•°æ®ï¼Œç”¨äºäº‹ååˆ†æ
python src/train_ddp.py --log_batch_metrics --epochs 200
```

**é€‚åˆ**ï¼š
- ç ”ç©¶è®­ç»ƒåŠ¨æ€
- åˆ†æè¿‡æ‹Ÿåˆ
- è°ƒä¼˜è¶…å‚æ•°

---

## è¾“å‡ºå†…å®¹è¯¦è§£

### æ¯ä¸ªBatchè¾“å‡ºçš„ä¿¡æ¯

```
Epoch [15/200] - è¿›åº¦ 5.8% (10/171) - Batch Loss: 0.072156 - LR: 0.00100000
  â†‘       â†‘         â†‘       â†‘  â†‘           â†‘                     â†‘
  â”‚       â”‚         â”‚       â”‚  â”‚           â”‚                     â””â”€ å½“å‰å­¦ä¹ ç‡
  â”‚       â”‚         â”‚       â”‚  â”‚           â””â”€ è¿™ä¸ªbatchçš„losså€¼
  â”‚       â”‚         â”‚       â”‚  â””â”€ æ€»batchæ•°
  â”‚       â”‚         â”‚       â””â”€ å½“å‰batchç¼–å·
  â”‚       â”‚         â””â”€ å®Œæˆç™¾åˆ†æ¯”
  â”‚       â””â”€ æ€»epochæ•°
  â””â”€ å½“å‰epoch
```

### æ¯ä¸ªEpochç»“æŸæ—¶çš„æ€»ç»“

```
================================================================================
Epoch [15/200] å®Œæˆ
å¹³å‡æŸå¤±: 0.072316          â† è¿™ä¸ªepochæ‰€æœ‰batchçš„å¹³å‡loss
æœ€å°BatchæŸå¤±: 0.065432      â† æœ€å¥½çš„batch
æœ€å¤§BatchæŸå¤±: 0.083571      â† æœ€å·®çš„batchï¼ˆç”¨äºåˆ¤æ–­ç¨³å®šæ€§ï¼‰
å­¦ä¹ ç‡: 0.00100000          â† å½“å‰å­¦ä¹ ç‡
æœ¬epochç”¨æ—¶: 14.52ç§’         â† è®­ç»ƒæ—¶é—´
é¢„è®¡å‰©ä½™æ—¶é—´: 0.75å°æ—¶       â† ETAé¢„ä¼°
================================================================================
```

---

## æ—¥å¿—æ–‡ä»¶

### å±å¹•è¾“å‡º vs æ–‡ä»¶ä¿å­˜

| ç±»å‹ | ä½ç½® | å†…å®¹ | æ§åˆ¶å‚æ•° |
|------|------|------|----------|
| **å±å¹•æ—¥å¿—** | ç»ˆç«¯æ˜¾ç¤º | æŒ‰`log_interval`æ˜¾ç¤º | `--log_interval 1` |
| **å®Œæ•´æ—¥å¿—** | `log/training_*.log` | æ‰€æœ‰æ—¥å¿—ï¼ˆæ— è®ºintervalï¼‰ | è‡ªåŠ¨ä¿å­˜ |
| **Epoch CSV** | `metrics/epoch_metrics_*.csv` | æ¯ä¸ªepochç»Ÿè®¡ | è‡ªåŠ¨ä¿å­˜ |
| **Batch CSV** | `metrics/batch_metrics_*.csv` | æ¯ä¸ªbatchè¯¦æƒ… | `--log_batch_metrics` |

**é‡ç‚¹**ï¼š
- å±å¹•è¾“å‡ºå¯ä»¥é€šè¿‡`--log_interval`æ§åˆ¶
- ä½†æ—¥å¿—æ–‡ä»¶`log/training_*.log`æ€»æ˜¯åŒ…å«æ‰€æœ‰ä¿¡æ¯
- CSVæ–‡ä»¶åªè®°å½•å…³é”®ç»Ÿè®¡æ•°æ®

---

## å®æ—¶æŸ¥çœ‹æŠ€å·§

### åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å¦å¼€ç»ˆç«¯

```bash
# å®æ—¶æŸ¥çœ‹å®Œæ•´æ—¥å¿—ï¼ˆåŒ…æ‹¬æ‰€æœ‰batchï¼‰
tail -f log/training_*.log

# åªçœ‹epochæ€»ç»“
tail -f log/training_*.log | grep "Epoch \["

# å®æ—¶æŸ¥çœ‹metricsæ•°æ®
tail -f metrics/epoch_metrics_*.csv
```

### ä½¿ç”¨screenæˆ–tmuxåå°è¿è¡Œ

```bash
# ä½¿ç”¨screen
screen -S training
python src/train_ddp.py
# æŒ‰ Ctrl+A ç„¶åæŒ‰ D ç¦»å¼€
# æŸ¥çœ‹: screen -r training

# ä½¿ç”¨tmux
tmux new -s training
python src/train_ddp.py
# æŒ‰ Ctrl+B ç„¶åæŒ‰ D ç¦»å¼€
# æŸ¥çœ‹: tmux attach -t training
```

---

## å¸¸è§é—®é¢˜

### Q: è¾“å‡ºå¤ªå¤šï¼Œçœ‹ä¸è¿‡æ¥æ€ä¹ˆåŠï¼Ÿ

A: å¢åŠ `--log_interval`ï¼š
```bash
python src/train_ddp.py --log_interval 20
```

### Q: æ€ä¹ˆåªçœ‹é‡è¦ä¿¡æ¯ï¼Ÿ

A: ä½¿ç”¨grepè¿‡æ»¤ï¼š
```bash
# åªçœ‹epochæ€»ç»“
python src/train_ddp.py 2>&1 | grep "Epoch \["

# åªçœ‹ä¿å­˜æ¨¡å‹çš„ä¿¡æ¯
python src/train_ddp.py 2>&1 | grep "å·²ä¿å­˜"
```

### Q: ä¸ºä»€ä¹ˆä¿®æ”¹é»˜è®¤ä¸ºæ¯ä¸ªbatchè¾“å‡ºï¼Ÿ

A: **ä¸ºäº†æ›´å¥½åœ°å­¦ä¹ AI**ï¼š
- çœ‹åˆ°æ¯ä¸ªbatchçš„å˜åŒ–ï¼Œç†è§£è®­ç»ƒåŠ¨æ€
- åŠæ—¶å‘ç°é—®é¢˜ï¼ˆlossçˆ†ç‚¸ã€NaNç­‰ï¼‰
- æ›´ç›´è§‚åœ°æ„Ÿå—æ¨¡å‹å­¦ä¹ è¿‡ç¨‹
- å¯¹æ–°æ‰‹æ›´å‹å¥½

### Q: è¿™ä¼šå½±å“è®­ç»ƒé€Ÿåº¦å—ï¼Ÿ

A: **å‡ ä¹ä¸ä¼š**ï¼š
- æ‰“å°åˆ°å±å¹•çš„å¼€é”€æå°ï¼ˆ<0.01%ï¼‰
- ä¸»è¦ç“¶é¢ˆæ˜¯GPUè®¡ç®—ï¼Œä¸æ˜¯æ—¥å¿—è¾“å‡º
- å¦‚æœæ‹…å¿ƒï¼Œå¯ä»¥è®¾ç½®`--log_interval 10`

### Q: å¦‚ä½•ä¿å­˜å±å¹•è¾“å‡ºï¼Ÿ

A:
```bash
# æ–¹æ³•1ï¼šé‡å®šå‘åˆ°æ–‡ä»¶
python src/train_ddp.py 2>&1 | tee my_training_output.txt

# æ–¹æ³•2ï¼šä½¿ç”¨nohup
nohup python src/train_ddp.py > training_output.log 2>&1 &
```

---

## å¯¹æ¯”ï¼šæ–° vs æ—§

| ç‰¹æ€§ | æ—§é»˜è®¤ | æ–°é»˜è®¤ |
|------|--------|--------|
| å±å¹•è¾“å‡ºé—´éš” | æ¯10ä¸ªbatch | **æ¯1ä¸ªbatch** |
| ä¿¡æ¯è¯¦ç»†åº¦ | ä¸­ç­‰ | **é«˜** |
| é€‚åˆäººç¾¤ | æœ‰ç»éªŒçš„ç”¨æˆ· | **æ‰€æœ‰ç”¨æˆ·ï¼Œç‰¹åˆ«æ˜¯å­¦ä¹ è€…** |
| æ˜¯å¦å¯è°ƒæ•´ | âœ… `--log_interval N` | âœ… `--log_interval N` |

---

## æ¨èå·¥ä½œæµ

### æ–°æ‰‹å­¦ä¹ æµç¨‹

```bash
# 1. å…ˆç”¨å°‘é‡epochsæµ‹è¯•ï¼ˆè§‚å¯Ÿæ¯ä¸ªbatchï¼‰
python src/train_ddp.py --epochs 5

# 2. åˆ†æç»“æœ
python analyze_training.py

# 3. æ­£å¼è®­ç»ƒï¼ˆå¯ä»¥é€‚å½“å‡å°‘è¾“å‡ºï¼‰
python src/train_ddp.py --log_interval 5 --epochs 200

# 4. æœ€ç»ˆåˆ†æ
python analyze_training.py
```

### è¿›é˜¶ç”¨æˆ·æµç¨‹

```bash
# ç›´æ¥æ­£å¼è®­ç»ƒï¼ˆå‡å°‘å±å¹•è¾“å‡ºï¼Œä½†ä¿å­˜è¯¦ç»†batchæ•°æ®ï¼‰
python src/train_ddp.py --log_interval 20 --log_batch_metrics --epochs 200

# è®­ç»ƒåæ·±åº¦åˆ†æ
python analyze_training.py
python analyze_training.py --batch_metrics
```

---

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æœ€è¯¦ç»†ï¼ˆé»˜è®¤ï¼‰
python src/train_ddp.py

# é€‚ä¸­ï¼ˆæ¯10ä¸ªbatchï¼‰
python src/train_ddp.py --log_interval 10

# ç®€æ´ï¼ˆæ¯50ä¸ªbatchï¼‰
python src/train_ddp.py --log_interval 50

# è¯¦ç»†+ä¿å­˜batchæ•°æ®
python src/train_ddp.py --log_batch_metrics

# ç®€æ´+ä¿å­˜batchæ•°æ®
python src/train_ddp.py --log_interval 20 --log_batch_metrics
```

---

## æ€»ç»“

### æ–°é»˜è®¤è®¾ç½®çš„ä¼˜åŠ¿

âœ… **å®æ—¶ç›‘æ§**ï¼šæ¯ä¸ªbatchéƒ½èƒ½çœ‹åˆ°
âœ… **åŠæ—¶å‘ç°é—®é¢˜**ï¼šlosså¼‚å¸¸ç«‹å³å¯è§
âœ… **å­¦ä¹ å‹å¥½**ï¼šæ›´å¥½åœ°ç†è§£è®­ç»ƒè¿‡ç¨‹
âœ… **çµæ´»è°ƒæ•´**ï¼šéšæ—¶å¯ä»¥å¢åŠ interval

### ä½•æ—¶è°ƒæ•´interval

- `--log_interval 1`ï¼šå­¦ä¹ ã€è°ƒè¯•ã€çŸ­æœŸè®­ç»ƒ
- `--log_interval 10-20`ï¼šæ­£å¼è®­ç»ƒã€å·²ç†Ÿæ‚‰è¿‡ç¨‹
- `--log_interval 50+`ï¼šè¶…é•¿è®­ç»ƒã€åªå…³å¿ƒæœ€ç»ˆç»“æœ

---

**ç«‹å³å¼€å§‹è®­ç»ƒï¼Œå®æ—¶è§‚å¯Ÿlosså˜åŒ–ï¼** ğŸš€

```bash
cd /workspace/GrayOcean/code/Medic_Project
python src/train_ddp.py --epochs 10
```
